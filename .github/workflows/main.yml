name: windows-msys2

on:
  workflow_dispatch:

jobs:
  msys2:
    runs-on: windows-latest

    steps:
    - name: Setup MSYS2 Environment
      uses: msys2/setup-msys2@v2
      with:
        msystem: ucrt64
        location: D:\
        update: true
        install: >-
          mingw-w64-ucrt64-toolchain
          mingw-w64-ucrt64-cmake
          mingw-w64-ucrt64-clang-libs
          mingw-w64-ucrt64-llvm-libs
          mingw-w64-ucrt64-clang-tools-extra
          mingw-w64-ucrt64-ninja
          mingw-w64-ucrt64-python
          mingw-w64-ucrt64-clang
          mingw-w64-ucrt64-llvm
          base-devel
          mingw-w64-ucrt64-qt5

    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: D:\msys64\opt\build
     
    - name: Build
      shell: msys2 {0}
      run: |
        cd /opt
        mkdir build && cd $_
        # Install Dependencies
        #wget -q https://github.com/zxunge/mingw-package-archives/archive/refs/tags/v1.0.tar.gz
        #tar xzf *.tar.gz
        #pacman -U --noconfirm mingw-package-archives-1.0/*.pkg.tar.zst
        
        wget -q https://download.qt.io/archive/qtcreator/8.0/8.0.2/qt-creator-opensource-src-8.0.2.tar.gz
        tar xzf qt-creator-opensource-src-8.0.2.tar.gz
        cd qt-creator-opensource-src-8.0.2/
        
        # Patch
        cp -f ../psapi.h /ucrt64/include/
        #cp -f ../CMakeLists.txt src/plugins/
        #cp -rf ../src ./
        cp -f ../src/plugins/clangformat/CMakeLists.txt ../src/plugins/clangformat/clangformatbaseindenter.cpp ../src/plugins/clangformat/clangformatutils.cpp src/plugins/clangformat/

        cmake . -Wno-dev                        \
          -GNinja                               \
          -DCMAKE_INSTALL_PREFIX=/opt/qtcreator \
          -DWITH_DOCS=ON             \
          -DBUILD_DEVELOPER_DOCS=ON  \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_QBS=OFF            \
          -DPython3_EXECUTABLE=/ucrt64/bin/python \
          -DWITH_TESTS=OFF           \
          -DCLANGTOOLING_LINK_CLANG_DYLIB=ON       
         
        cmake --build . --parallel $(nproc)
        cmake --build . --target docs
        cmake --install .
         
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QtCreator
        path: D:\msys64\opt\qtcreator
